<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }

      #login, #lobby { display: none; }
      #login.active, #lobby.active { display: block; }

      #login { background: #000; width: 100vw; height: 100vh; }
      #login form { display: flex; align-items: center; justify-content: center; height: 100%; }
      #login form input { padding: 20px; width: 200px; }
      #login form button { padding: 20px; margin-left: 10px; }


      #panel { display: grid; grid-template-columns: 1fr 5fr; }

      #lobby-users { background: #C0C0C0; height: 100vh; }

      #lobby-messages { list-style-type: none; margin: 0; padding: 0; }
      #lobby-messages li { padding: 5px 10px; }
      #lobby-messages li:nth-child(odd) { background: #eee; }

      #lobby form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      #lobby form input { border: 0; padding: 10px; width: 90%; margin-right: 0.5%; }
      #lobby form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
    </style>
  </head>
  <body>
    <section id="login" class="active">
      <form>
        <input autocomplete="off">
        <button>Send</button>
      </form>
    </section>
    <section id="lobby">
      <div id="panel">
        <ul id="lobby-users"></ul>
        <ul id="lobby-messages"></ul>
      </div>
      <form>
        <input autocomplete="off">
        <button>Send</button>
      </form>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script>
      const socket = io()

      function addLobbyUser ({ id, name }) {
        const $li = document.createElement('li')
        $li.id = `user-${id}`
        $li.appendChild(document.createTextNode(name))
        document.querySelector('#lobby-users').appendChild($li)
      }

      function addLobbyMessage (message) {
        const formattedMessage = message.replace(/(<([^>]+)>)/gi, '')
        const $li = document.createElement('li')
        $li.appendChild(document.createTextNode(formattedMessage))
        document.querySelector('#lobby-messages').appendChild($li)
      }

      // A new user enters the game
      document.querySelector('#login form').addEventListener('submit', function(e) {
        e.preventDefault()

        const $input = document.querySelector('#login input')
        const name = $input.value

        if (name) {
          socket.emit('join', name)
          $input.value = ''

          // Change screens
          document.querySelector('#login').classList.remove('active')
          document.querySelector('#lobby').classList.add('active')

          // Add myself name to user list
          addLobbyUser({ id: 'myself', name })
        }
      })

      // A new message is sent
      document.querySelector('#lobby form').addEventListener('submit', function (e) {
        e.preventDefault()

        const $input = document.querySelector('#lobby input')
        socket.emit('message', $input.value)
        $input.value = ''
      })

      socket.on('user list', function (response) {
        response.forEach(addLobbyUser)
      })

      socket.on('user joined', function (response) {
        addLobbyMessage(`${response.name} has joined the game`)
        addLobbyUser(response)
      })

      socket.on('user left', function (response) {
        addLobbyMessage(`${response.name} has left the game`)
        document.querySelector(`#user-${response.id}`).remove()
      })

      socket.on('message sent', addLobbyMessage)
    </script>
  </body>
</html>
